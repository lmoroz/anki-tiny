# Proposal: Add Training Limits

## Overview

Добавить систему лимитов для контроля количества карточек в тренировках, чтобы предотвратить перегрузку пользователя и
обеспечить управляемый процесс обучения.

## Problem Statement

В текущей реализации при запуске тренировки API возвращает **все** карточки, готовые к повторению, без каких-либо
ограничений. Это создаёт проблемы:

1. **Перегрузка пользователя**: если накопилось 200+ карточек, пользователь увидит их все и может выгореть
2. **Отсутствие контроля**: нет возможности дозировать нагрузку
3. **Мультикурсовость**: при наличии нескольких курсов невозможно распределить внимание равномерно
4. **Нет учёта новых vs повторений**: новые карточки требуют больше когнитивной нагрузки, чем повторения

## Proposed Solution

Внедрить **четырёхуровневую систему лимитов**:

### 1. Глобальные дневные лимиты (по всем курсам)

- `globalNewCardsPerDay` (default: 20) — максимум новых карточек в день **по всем курсам**
- `globalMaxReviewsPerDay` (default: 200) — максимум повторений в день **по всем курсам**

### 2. Курсовые дневные лимиты (per course)

- `newCardsPerDay` (default: 20) — максимум новых карточек в день **для этого курса**
- `maxReviewsPerDay` (default: 200) — максимум повторений в день **для этого курса**

### 3. Сессионные лимиты (per training session)

- `newCardsPerSession` (default: 10) — новых карточек за одну сессию
- `maxReviewsPerSession` (default: 50) — повторений за одну сессию

### 4. Приоритеты между курсами

- Глобальные лимиты распределяются между курсами **пропорционально** количеству готовых карточек
- Или используется **round-robin** при равных приоритетах

## User Value

- ✅ **Управляемая нагрузка**: пользователь сам решает, сколько карточек готов изучать
- ✅ **Предотвращение выгорания**: разумные дефолтные значения защищают от перегрузки
- ✅ **Мультикурсовость**: справедливое распределение внимания между курсами
- ✅ **Гибкость**: можно настроить как глобально, так и для каждого курса отдельно
- ✅ **Совместимость с Anki**: знакомая модель для пользователей Anki

## Technical Approach

### Database Changes

1. **Добавить поля в `settings` таблицу** (глобальные лимиты):
   - `globalNewCardsPerDay: number` (default: 20)
   - `globalMaxReviewsPerDay: number` (default: 200)

2. **Добавить поля в `courseSettings` таблицу** (курсовые лимиты):
   - `newCardsPerDay: number | null` (default: 20)
   - `maxReviewsPerDay: number | null` (default: 200)
   - `newCardsPerSession: number | null` (default: 10)
   - `maxReviewsPerSession: number | null` (default: 50)

3. **Создать таблицу `dailyProgress`** для отслеживания прогресса:

```sql
CREATE TABLE dailyProgress
(
    id               INTEGER PRIMARY KEY AUTOINCREMENT,
    date             TEXT    NOT NULL, -- YYYY-MM-DD
    courseId         INTEGER NOT NULL,
    newCardsStudied  INTEGER DEFAULT 0,
    reviewsCompleted INTEGER DEFAULT 0,
    createdAt        TEXT    NOT NULL,
    updatedAt        TEXT    NOT NULL,
    FOREIGN KEY (courseId) REFERENCES courses (id) ON DELETE CASCADE,
    UNIQUE (date, courseId)
);
```

### API Changes

**GET /api/courses/:courseId/due-cards**

- Учитывать глобальные лимиты (сколько уже изучено сегодня по всем курсам)
- Учитывать курсовые лимиты (сколько осталось для этого курса)
- Учитывать сессионные лимиты
- Возвращать метаданные о лимитах

**POST /api/training/review**

- Обновлять `dailyProgress` после каждого повторения
- Инкрементировать счётчики новых/повторённых карточек

**Новый endpoint: GET /api/training/stats**

- Возвращает статистику за день по всем курсам

### Frontend Changes

1. **Настройки — глобальные** (`SettingsForm.vue`):
   - Добавить поля для `globalNewCardsPerDay`, `globalMaxReviewsPerDay`

2. **Настройки — курсовые** (`CourseSettingsModal.vue`):
   - Добавить поля для всех 4 курсовых лимитов
   - Показывать наследование от глобальных настроек

3. **Страница курса** (`CoursePage.vue`):
   - Показывать "Осталось сегодня: X новых / Y повторений"

4. **Страница тренировки** (`TrainingPage.vue`):
   - Показывать прогресс сессии: "10/50 карточек в сессии"
   - Кнопка "Продолжить" для новой сессии

## Success Criteria

- [ ] Пользователь может установить глобальные дневные лимиты
- [ ] Пользователь может установить курсовые дневные и сессионные лимиты
- [ ] При запуске тренировки возвращается не более N карточек согласно лимитам
- [ ] Статистика за день корректно отслеживается и отображается
- [ ] Лимиты сбрасываются при достижении `trainingStartTime` или при открытии приложения после этого времени
- [ ] UI показывает оставшиеся лимиты на сегодня

## Out of Scope

- Автоматический подбор оптимальных лимитов на основе истории
- Приоритезация курсов (какой курс изучать в первую очередь)
- Неограниченный режим (можно добавить позже через `maxValue = -1`)

## Dependencies

- Extends: `settings-global-management`, `settings-course-management`
- Creates: New spec `training-limits`

## Risks & Mitigation

**Риск 1**: Сложность распределения глобальных лимитов между курсами

- **Митигация**: Начать с простого подхода — пропорциональное распределение по количеству готовых карточек

**Риск 2**: Пользователь может запутаться в 4 уровнях лимитов

- **Митигация**: Хорошие дефолты + UI подсказки о том, какой лимит сработал

**Риск 3**: Определение "нового дня" для сброса лимитов

- **Митигация**: "Новый день" начинается в `trainingStartTime` (например, 08:00)
- **Реализация**: При запросе карточек проверяем:
  1. Последний сохранённый прогресс был до сегодняшнего `trainingStartTime`?
  2. Если да → считаем это новым днём, игнорируем старый прогресс
  3. Если нет → используем прогресс из `dailyProgress`
- **Преимущество**: Не требует background процессов, работает даже если приложение было закрыто
