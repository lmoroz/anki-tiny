# Proposal: System Tray Integration

## Why

Приложение Repetitio не должно полностью закрываться при нажатии кнопки закрытия окна, чтобы пользователь мог быстро вернуться к тренировкам в любой момент. Интеграция с системным треем обеспечит фоновую работу приложения и соответствует стандартным практикам desktop-приложений для продуктивности.

## Problem

Текущая реализация полностью завершает процесс приложения при нажатии на кнопку закрытия окна (крестик). Это приводит к:

- **Потере контекста**: пользователь теряет возможность быстро вернуться к тренировке
- **Дополнительная нагрузка**: при повторном запуске требуется заново инициализировать все сервисы
- **Несоответствие UX паттернам**: большинство desktop-приложений для продуктивности (Slack, Discord, Notion) сворачиваются в трей вместо полного закрытия
- **Отсутствие визуального индикатора**: нет способа быстро открыть приложение из системной панели задач

## Proposed Solution

Реализовать интеграцию с **Electron Tray API** с следующим поведением:

1. **Минимизация вместо закрытия**:
   - При нажатии кнопки закрытия окна (`window-close` IPC) приложение не завершается, а скрывается (`window.hide()`)
   - В системном трее появляется иконка приложения
   - Процесс Electron продолжает работать в фоне

2. **Контекстное меню трея**:
   - **Показать/Скрыть Repetitio** — переключает видимость главного окна
   - **Разделитель**
   - **Закрыть Repetitio** — полностью завершает приложение (`app.quit()`)

3. **Поведение клика по иконке трея**:
   - **Левый клик**: показать окно, если оно скрыто; скрыть окно, если оно видимо (toggle)
   - **Правый клик**: открыть контекстное меню

4. **Восстановление окна**:
   - При показе скрытого окна восстанавливается прежний размер и позиция
   - Если окно было свёрнуто (`minimized`), оно разворачивается

### Benefits

- ✅ **Быстрый доступ** — пользователь может мгновенно вернуться к тренировкам через трей
- ✅ **Экономия ресурсов** — не требуется перезапускать приложение и переинициализировать сервисы
- ✅ **Стандартный UX** — поведение соответствует ожиданиям пользователей desktop-приложений
- ✅ **Основа для уведомлений** — создаёт фундамент для будущей интеграции системных уведомлений

## Impact Analysis

### Modified Components

- **Backend (Electron main process)**:
  - `backend/src/electron/main.ts` — создание Tray, обработка событий окна
  - IPC handler `window-close` — изменение поведения с `win.close()` на `win.hide()`
  - Добавление нового IPC handler `app-quit` для полного завершения из меню

- **Frontend**:
  - `frontend/src/widgets/title-bar/TitleBar.vue` — обновление tooltip кнопки закрытия (опционально)

- **Assets**:
  - Создание иконки для трея (`backend/icon-tray.png` — 16x16 или 32x32)

### Dependencies

- `electron.Tray` API (доступен в Electron 39+)
- `electron.Menu` API для контекстного меню
- Требуется тестирование на Windows, Linux, macOS (разные поведения трея)

### Risks

- **Платформенные различия**:
  - Windows: трей справа в taskbar, правый клик открывает меню
  - macOS: трей в menu bar сверху, левый клик открывает меню
  - Linux: зависит от DE (GNOME, KDE, etc.)
- **Двойная иконка на taskbar** (Windows): при показе окна может появляться и в трее, и на панели задач (требует настройки `skipTaskbar`)
- **Lifecycle сложность**: необходима корректная очистка Tray при `app.quit()`

## Alternative Approaches Considered

### Минимизация в taskbar (без трея)

- ❌ **Низкая доступность**: иконка теряется среди других окон на панели задач
- ❌ **Нет быстрого доступа**: требуется искать окно в списке задач

### Разрешить полное закрытие с опцией "Запомнить выбор"

- ❌ **Избыточная сложность**: требует дополнительные настройки и UI для выбора
- ❌ **Не соответствует UX паттернам**: большинство приложений просто сворачиваются

### Использование системных уведомлений вместо трея

- ❌ **Не решает проблему**: уведомления не заменяют постоянный доступ к приложению
- ❌ **Меньше контроля**: нельзя быстро переключить видимость окна

## Out of Scope

- Настройка поведения закрытия (опция "Закрывать полностью" в Settings) — может быть добавлена в будущем
- Badge на иконке трея с количеством due карточек — будет реализовано отдельно
- Системные уведомления при готовности карточек — отдельная фича
- Интеграция с macOS Dock — не требуется для MVP

## Success Metrics

- ✅ **Окно скрывается при закрытии**: нажатие на крестик не завершает процесс
- ✅ **Иконка в трее видима**: приложение отображается в системном трее
- ✅ **Меню работает**: контекстное меню трея открывается и функционирует
- ✅ **Клик по трею**: левый клик переключает видимость окна
- ✅ **Полное завершение**: пункт меню "Закрыть Repetitio" корректно завершает процесс
- ✅ **Корректная очистка**: tray удаляется при `app.quit()`
