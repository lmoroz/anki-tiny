# Proposal: Real-Time Statistics Updates via Server-Sent Events

## Why

Текущая реализация обновления статистики на главной странице основана на неэффективном polling подходе, который создаёт избыточную нагрузку на систему и ухудшает пользовательский опыт. Замена на Server-Sent Events решит эти проблемы, обеспечив мгновенные обновления при минимальном использовании ресурсов.

## Problem

Текущая реализация обновления статистики на главной странице основана на polling через `setTimeout` с интервалом в 5 секунд. Это приводит к:

- **Избыточным запросам**: бэкенд постоянно получает запросы даже когда данные не изменились
- **Задержке обновления**: изменения становятся видны только после очередного poll
- **Неэффективному использованию ресурсов**: клиент и сервер выполняют работу впустую
- **Отсутствию предсказуемости**: невозможно точно знать, когда следующая карточка станет due

## Proposed Solution

Заменить polling на **Server-Sent Events (SSE)** с интеллектуальным планированием обновлений:

1. **Бэкенд вычисляет момент следующего изменения** — запрашивает из БД карточку с ближайшим `due` в будущем и планирует на это время:
   - Запрос обновлённой статистики по всем курсам
   - Отправку события с новыми данными всем подключённым клиентам
   - Повторное планирование следующего обновления

2. **Бэкенд отправляет обновления при изменениях** — после операций, изменяющих статистику (завершение тренировки, редактирование настроек, добавление/удаление карточек), бэкенд немедленно отправляет актуальные данные через SSE

3. **Фронтенд подписывается на SSE** — главная страница устанавливает EventSource соединение и реактивно обновляет UI при получении новых данных

### Benefits

- ✅ **Нулевая задержка** — изменения доходят мгновенно
- ✅ **Минимум трафика** — данные отправляются только при реальных изменениях
- ✅ **Предсказуемость** — система точно знает, когда произойдёт следующее изменение
- ✅ **Масштабируемость** — SSE поддерживает множество клиентов через единый механизм

## Impact Analysis

### Modified Components

- **Backend**:
  - Новый endpoint `GET /api/stats/stream` для SSE
  - Новый `StatsScheduler` сервис для управления планированием
  - Обновление `cardRepository` — метод для поиска следующей due карточки
  - Обновление роутов `training`, `cards`, `courses`, `settings` — отправка SSE при изменениях

- **Frontend**:
  - Обновление `HomePage.vue` — замена `setTimeout` на `EventSource`
  - Composable `useStatsStream` для управления SSE соединением

### Dependencies

- Требуется реализовать graceful shutdown для планировщика
- Необходима обработка переподключения SSE при разрыве соединения
- Требуется координация между несколькими источниками событий

### Risks

- **SSE Browser Limits**: браузеры ограничивают количество одновременных SSE соединений (обычно 6 на домен), но для desktop приложения это не критично
- **Memory Leaks**: необходимо корректно очищать таймеры при отключении клиентов
- **Clock Drift**: возможны расхождения между запланированным и реальным временем обновления (решается повторной проверкой БД)

## Alternative Approaches Considered

### WebSocket

- ❌ **Overcomplicated**: требует full-duplex, хотя нужен только server-to-client
- ❌ **More boilerplate**: требуется отдельная библиотека (socket.io)

### Long Polling

- ❌ **Same problems as current**: избыточные запросы, задержки
- ❌ **More complex**: требуется управление timeout и reconnect

### Keeping setTimeout

- ❌ **Inefficient**: продолжает делать бесполезные запросы
- ❌ **Poor UX**: задержка до 5 секунд для обновления данных

## Out of Scope

- Использование SSE для других частей приложения (пока только статистика)
- Реализация fallback на polling при недоступности SSE (Edge case для desktop app)
- Обработка множественных окон приложения (Electron по умолчанию создаёт одно окно)

## Success Metrics

- ✅ **Устранение polling**: `setTimeout` полностью удалён из `HomePage.vue`
- ✅ **Мгновенное обновление**: статистика обновляется \<100ms после изменения данных
- ✅ **Точное планирование**: обновление происходит в момент, когда карточка становится due (±1 секунда)
- ✅ **Стабильное соединение**: SSE автоматически переподключается при разрыве
